<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body style="display: flex; justify-content:center">
  <div class="border-3 border mt-5 d-flex" style="width: 700px; height: 400px;">
    <div style="padding: none; background-color: rgb(0, 106, 255); width: 200px; color: white;">
    </div>
    <div style="padding-left: 5%; padding-top: 5%; width: 500px;">
      <div>
        <div style="display: flex; align-items: center;">
          <h2> User Information</h2>
          <i class="fa-solid fa-pen-to-square" style="padding-left: 2%;" id="edit"></i>
        </div>
        <div id="theone"></div>
        <div id="car"></div>
        <div id="three"></div>
        <div id="two"></div>
      </div>
      <div style="padding-top: 7%; position: fixed;" id="K">
      </div>
    </div>
  </div>
  <style>
    .input {
      width: 200px;
      margin-bottom: 2%;
    }

    b {
      padding-right: 1%;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      signInWithEmailAndPassword,
      getAuth,
      deleteUser,
      onAuthStateChanged,
      updatePassword,
      signOut,
      updateProfile,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      child,
      get,
      set,
      push,
      onValue,
      update,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB5CBskeDYo_DpeskcP7B4K0qKwuGvtnn0",
      authDomain: "foodpsykes.firebaseapp.com",
      projectId: "foodpsykes",
      storageBucket: "foodpsykes.appspot.com",
      messagingSenderId: "429664914347",
      appId: "1:429664914347:web:6d1e41cf493d55561de0ee",
      measurementId: "G-86M6HF41TQ",
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app)
    const db = getDatabase();
    const auth = getAuth(app);
    const first = document.getElementById("car");
    const second = document.getElementById("theone");
    const plane = document.getElementById("two")
    const three = document.getElementById('three')
    // console.log(user)
    window.LoadUser = function () {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const uid = user.uid;
          const userRef = ref(database, `users/${uid}`);
          onValue(userRef, (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              const first = document.getElementById("car");
              const second = document.getElementById("theone");
              const plane = document.getElementById("two")
              const three = document.getElementById('three')
              first.innerHTML = `<p>Email: ${userData.email}</p>`
              second.innerHTML = `<p>Username: ${userData.username}</p>`
              three.innerHTML = `<p>Role: ${userData.Role}</p>`
              plane.innerHTML = `<p>Create Date: ${userData.createdAt}</p>`
              document.getElementById('K').innerHTML = `
            <button id="delete" class="btn btn-primary" onclick="third()">Delete User</button>
        <button onclick="logout()" class="btn btn-primary">Sign Out</button>
        <button onclick="Manage()" class="btn btn-primary">Manage Page</button>
            `
            }
          })
        } else {
          console.log('error')
        }
      })
    }
    LoadUser()
    window.third = function () {
      const auth = getAuth();
      const user = auth.currentUser;
      deleteUser(user).then(() => {
        window.location.href = "http://127.0.0.1:5500/code/login.html";
      })
        .catch((error) => {
          console.log(error);
        });
    }
    onValue(ref(db, "users"), (snapshot) => {
      const data = snapshot.val();
      console.log(data);
    });
    window.logout = function () {
      signOut(auth)
        .then(() => {
          window.location.href = "http://127.0.0.1:5500/code/login.html";
        })
        .catch((error) => {
          console.log(error);
        });
    }
    window.Manage = function () {
      window.location.href = 'http://127.0.0.1:5500/code/Foodlist.html'
    }
    const test = document.getElementById('edit')
    edit.addEventListener('click', () => {
      const userRef = ref(database, "users")
      onValue((userRef), snapshot => {
        snapshot.forEach((childSnapshot) => {
          const user = auth.currentUser;
          const userData = childSnapshot.val()
          if (userData.email.toLowerCase().includes(user.email)) {
            first.innerHTML = `<b>Email</b><input value='${userData.email}' class='input' id='email'>`
            second.innerHTML = `<b>Username</b><input value= '${userData.username}' class='input' id='name'>`
            three.innerHTML = `<b>Role</b><input value='${userData.Role}' class='input' disabled>`
            plane.innerHTML = `<b>Create Date</b><input value='${userData.createdAt}' class='input' disabled>`
            document.getElementById('K').innerHTML = `
            <button class='btn btn-primary' onclick="Change()">Confirm</button>
            <button class='btn btn-primary' onclick="cancel()">Cancel</button>
            `
          }
        })
      })
    })
    window.cancel = function () {
      LoadUser()
    }
    window.Change = function () {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const uid = user.uid;
          const updateData = {
            username: document.getElementById('name').value,
            email: document.getElementById('email').value
          }
          const userRef = ref(database, `users/${uid}`);
          update(userRef, updateData)
            .then(() => {
              console.log('success')
              LoadUser()
            })
            .catch((error) => {
              console.error(error)
            })
        }
      })
    }
    onAuthStateChanged(auth, (user) => {
      console.log(user);
      if (user?.email) {
      } else {
        console.log("Chưa đăng nhập");
        window.location.href = "http://127.0.0.1:5500/code/login.html";
      }
    }
    )
  </script>
</body>

</html>